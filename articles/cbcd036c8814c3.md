---
title: "[Turborepo] ãƒ¢ãƒãƒ¬ãƒç’°å¢ƒå†…ã®Next.jsã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹"
emoji: "ğŸ¦–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Turborepo,yarn, Next,Docker]
published: true
---
ãƒ¢ãƒãƒ¬ãƒåŒ–ã•ã‚Œã¦ã„ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®ä¸­ã®Next.jsã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã«å¿…è¦ã ã£ãŸDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã¨ãã«ã€è‰²ã€…æ¨¡ç´¢ã—ãŸã®ã§ãã®å‚™å¿˜éŒ²ã§ã™ã€‚è©³ã—ã„è§£èª¬ã¯ç«¯æŠ˜ã£ã¦ã¾ã™ãŒã€èª°ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

### ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ
```
.
â”œâ”€â”€ apps
â”‚   â””â”€â”€ webï¼ˆNext.jsï¼‰
â”‚        â”œâ”€â”€ docker
â”‚        â”‚    â”œâ”€â”€ development
â”‚        â”‚    â”‚   â””â”€â”€ Dockerfile
â”‚        â”‚    â””â”€â”€ prod
â”‚        â”‚         â””â”€â”€ Dockerfile
â”‚        â”” package.json
â”œâ”€â”€ packages
â”‚   â””â”€â”€ db
â”‚        â”” package.json
â”œâ”€â”€ shared
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ package.json
â””â”€â”€ yarn.lock
```

ä»Šå›ã¯Turborepoã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ¢ãƒãƒ¬ãƒç’°å¢ƒå†…ã®Nextã‚¢ãƒ—ãƒªã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚


### Nextã®è¨­å®š
ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã§ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã§ãã‚‹ã€‚
ã‚¢ãƒ—ãƒªã®èµ·å‹•ã¯`next start`ã§ã¯ãªãã€`node server.js`ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
`public`ãƒ•ã‚©ãƒ«ãƒ€ã‚„`.next/static`ãƒ•ã‚©ãƒ«ãƒ€ã¯ã‚³ãƒ”ãƒ¼ã•ã‚Œãªã„ãŸã‚ã€Dockerfileã®è¨˜è¿°æ™‚ã«åˆ¥é€”ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚ˆã†ã«æ³¨æ„ã™ã‚‹ã€‚

```javascript:next.config.js
const nextConfig = {
  // ...ä»–ã®è¨­å®š
  output: "standalone",
}

module.exports = nextConfig
```



### Dockerfileã®è¨˜è¿°

```Dockerfile:Dockerfile
FROM node:18-alpine AS base
WORKDIR /app
RUN corepack enable yarn

FROM base AS turbo
RUN yarn global add turbo
COPY . .

COPY ./apps/web/.env.development ./apps/web/.env.production
RUN turbo prune --scope=@workspaceName/web --docker

FROM base AS builder
# Nextã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã¯node-gypãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå¿…è¦ã§ã€ã“ã‚Œã‚‰ã®ãƒ“ãƒ«ãƒ‰ã«ã¯pythonãŒå¿…è¦ã ãŒalpineã«ã¯ãªã„ã€‚
RUN apk add --no-cache python3 make g++ libc6-compat
COPY --from=turbo /app/out/json/ .
COPY --from=turbo /app/out/yarn.lock ./yarn.lock
RUN yarn install

COPY --from=turbo /app/out/full/ .
RUN yarn turbo run build --filter=@workspaceName/web
RUN apk --no-cache add curl && curl -sf https://gobinaries.com/tj/node-prune | sh && node-prune


FROM base AS runner
#rootæ¨©é™ã§å®Ÿè¡Œã—ãªã„
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
USER nextjs

COPY --from=builder --chown=nextjs:nodejs app/apps/web/.next/standalone ./
# ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§publicã¨.next/staticã¯ã‚³ãƒ”ãƒ¼ã•ã‚Œãªã„ãŸã‚ã€ã“ã“ã§ã‚³ãƒ”ãƒ¼ã™ã‚‹
COPY --from=builder --chown=nextjs:nodejs app/apps/web/public ./apps/web/public
COPY --from=builder --chown=nextjs:nodejs app/apps/web/.next/static ./apps/web/.next/static

WORKDIR /app/apps/web

CMD node server.js
```


## å‚è€ƒæ–‡çŒ®
@[card](https://turbo.build/repo/docs/handbook/deploying-with-docker)
@[card](https://nextjs.org/docs/pages/api-reference/next-config-js/output#automatically-copying-traced-files)