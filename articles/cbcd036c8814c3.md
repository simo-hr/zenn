---
title: "TurborepoÃ—yarnÃ—Next.jsæ§‹æˆã®ã‚¢ãƒ—ãƒªã‚’Dockerã§build/deployã™ã‚‹æ–¹æ³•"
emoji: "ğŸ¦€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Turborepo,yarn, Next.js,Docker]
published: false
---
ãƒ¢ãƒãƒ¬ãƒï¼ˆTurborepoï¼‰æ§‹æˆã®ä¸­ã«ã‚ã‚‹Next.jsã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ã ã£ãŸDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¨˜è¿°ã™ã‚‹ã¨ãã®å‚™å¿˜éŒ²ã§ã™ã€‚



### ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ
```
.
â”œâ”€â”€ apps
â”‚   â””â”€â”€ webï¼ˆNext.jsï¼‰
â”‚        â””â”€â”€ docker
â”‚             â”œâ”€â”€ development
â”‚             â”‚   â””â”€â”€ Dockerfile
â”‚             â””â”€â”€ prod
â”‚                  â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ packages
â”‚   â””â”€â”€ db
â”œâ”€â”€ shared
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ package.json
â””â”€â”€ yarn.lock
```

### Nextã®è¨­å®š
ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã™ã‚‹ãŸã‚ã«ã€ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¦ãŠãã€‚
èµ·å‹•æ™‚ã¯next startã§ã¯ãªãã€å‡ºåŠ›ã•ã‚Œã‚‹server.jsã‚’å®Ÿè¡Œã™ã‚‹ã€‚
publicãƒ•ã‚©ãƒ«ãƒ€ã‚„.next/staticãƒ•ã‚©ãƒ«ãƒ€ã¯ã‚³ãƒ”ãƒ¼ã•ã‚Œãªã„ãŸã‚ã€Dockerfileã®è¨˜è¿°æ™‚ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚ˆã†ã«æ³¨æ„ã™ã‚‹ã€‚

```javascript:next.config.js
const nextConfig = {
  // ...ç•¥
  output: "standalone",
}

module.exports = nextConfig
```
@[card](https://nextjs.org/docs/pages/api-reference/next-config-js/output#automatically-copying-traced-files)


### Dockerfileã®è¨˜è¿°

```Dockerfile:Dockerfile
FROM node:18-alpine AS base
WORKDIR /app
RUN corepack enable yarn

FROM base AS turbo
RUN yarn global add turbo
COPY . .
# Nextã¯èµ·å‹•ã®ä»•æ–¹ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§èª­ã¿è¾¼ã‚€.envã®ãƒ•ã‚¡ã‚¤ãƒ«åãŒæ±ºã¾ã£ã¦ã„ã‚‹ã€‚
# ä»Šå›ã¯.env.productionã‚’ç”¨æ„ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ã§ã€ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚
COPY ./apps/web/.env.development ./apps/web/.env.production
RUN turbo prune --scope=@workspaceName/web --docker

FROM base AS builder
# Nextã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã¯node-gypãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã“ã‚Œã‚‰ã®ãƒ“ãƒ«ãƒ‰ã«ã¯pythonãŒå¿…è¦ã ãŒã€alpineã«ã¯ãªã„ã€‚
RUN apk add --no-cache python3 make g++ libc6-compat
COPY --from=turbo /app/out/json/ .
COPY --from=turbo /app/out/yarn.lock ./yarn.lock
RUN yarn install

COPY --from=turbo /app/out/full/ .
RUN yarn turbo run build --filter=@workspaceName/web
RUN apk --no-cache add curl && curl -sf https://gobinaries.com/tj/node-prune | sh && node-prune


FROM base AS runner
#rootæ¨©é™ã§å®Ÿè¡Œã—ãªã„
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
USER nextjs

COPY --from=builder --chown=nextjs:nodejs app/apps/web/.next/standalone ./
# ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§publicã¨.next/staticã¯ã‚³ãƒ”ãƒ¼ã•ã‚Œãªã„ãŸã‚ã€ã“ã“ã§ã‚³ãƒ”ãƒ¼ã™ã‚‹
COPY --from=builder --chown=nextjs:nodejs app/apps/web/public ./apps/web/public
COPY --from=builder --chown=nextjs:nodejs app/apps/web/.next/static ./apps/web/.next/static

WORKDIR /app/apps/web

CMD node server.js
```


## å‚è€ƒæ–‡çŒ®
https://turbo.build/repo/docs/handbook/deploying-with-docker